---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import LinkButton from "@/components/LinkButton.astro";
import Card from "@/components/Card.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SITE } from "@/config";

const posts = await getCollection("blog");

const sortedPosts = getSortedPosts(posts);
const latestPosts = sortedPosts.slice(0, SITE.postPerIndex);
---

<Layout>
  <Header />
  <main id="main-content" data-layout="index" class="space-y-14 pb-20">
    <section id="hero" class="pt-12">
      <p class="text-xs uppercase tracking-[0.4em] text-foreground/60">The Mountain King</p>
      <p class="mt-6 max-w-2xl text-xl leading-relaxed text-foreground/85">
        I build and break AI systems.
      </p>
      <div class="mt-8 flex flex-wrap gap-4 text-sm">
        <LinkButton href="/posts" class="underline underline-offset-4">
          Start reading
        </LinkButton>
        <LinkButton href="/projects" class="underline underline-offset-4">
          See current builds
        </LinkButton>
      </div>
    </section>

    <section id="latest" class="space-y-6">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-baseline sm:justify-between">
        <div>
          <h2 class="text-2xl font-semibold">Latest from the forge</h2>
          
        </div>
        <LinkButton
          href="/posts/"
          class="text-xs uppercase tracking-[0.28em] text-foreground/70 hover:text-accent"
        >
          View all
          <IconArrowRight class="ms-1 inline-block size-4 rtl:-rotate-180" />
        </LinkButton>
      </div>
      {
        latestPosts.length === 0 ? (
          <p class="text-sm text-foreground/60">No posts yet. Check back soon.</p>
        ) : (
          <ul class="space-y-6">
            {latestPosts.map(data => (
              <Card variant="h3" {...data} />
            ))}
          </ul>
        )
      }
    </section>

    <section id="projects" class="space-y-6">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-baseline sm:justify-between">
        <div>
          <h2 class="text-2xl font-semibold">Recent Projects</h2>
        </div>
        <LinkButton
          href="/projects"
          class="text-xs uppercase tracking-[0.28em] text-foreground/70 hover:text-accent"
        >
          All projects
          <IconArrowRight class="ms-1 inline-block size-4 rtl:-rotate-180" />
        </LinkButton>
      </div>
      <div class="space-y-5 text-sm text-foreground/70">
        <article class="space-y-2">
          <p class="text-xs uppercase tracking-[0.28em] text-foreground/60">Retrieval systems</p>
          <div class="flex flex-col gap-2 md:flex-row md:items-baseline md:justify-between">
            <div>
              <h3 class="text-lg font-medium text-foreground">Production-Ready RAG @ 1M+ Vectors</h3>
              <p class="text-foreground/60">
                Secure retrieval pipeline with observability baked in, tuned for low-latency
                inference and aggressive poisoning detection.
              </p>
            </div>
            <div class="flex flex-wrap gap-3 text-xs">
              <LinkButton href="/projects" class="underline underline-offset-4">
                Project notes
              </LinkButton>
              <LinkButton href="https://github.com/TheMntnKing/production-rag" class="underline underline-offset-4">
                GitHub
              </LinkButton>
            </div>
          </div>
        </article>

        <article class="space-y-2">
          <p class="text-xs uppercase tracking-[0.28em] text-foreground/60">Offensive research</p>
          <div class="flex flex-col gap-2 md:flex-row md:items-baseline md:justify-between">
            <div>
              <h3 class="text-lg font-medium text-foreground">Adversarial Attack Library</h3>
              <p class="text-foreground/60">
                Operator-friendly kits for pressure-testing LLM agents with automated reports
                and guardrail benchmarks.
              </p>
            </div>
            <div class="flex flex-wrap gap-3 text-xs">
              <LinkButton href="/projects" class="underline underline-offset-4">
                Project notes
              </LinkButton>
              <LinkButton href="https://github.com/TheMntnKing/adversarial-attack-library" class="underline underline-offset-4">
                GitHub
              </LinkButton>
            </div>
          </div>
        </article>
      </div>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
